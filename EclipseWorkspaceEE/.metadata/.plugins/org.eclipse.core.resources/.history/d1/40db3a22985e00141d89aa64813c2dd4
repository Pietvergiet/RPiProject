package login;

import java.io.IOException;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;

import controller.DatabaseController;

@WebServlet("/LogIn")
public class Login extends HttpServlet{

	/**
	 * 
	 */
	private static final long serialVersionUID = 1L;

	protected void doPost(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
		response.setContentType("text/html;charset=UTF-8");
		String user = request.getParameter("id");
		String pass = request.getParameter("pass");

		if(new Validate().checkUser(user, pass)) {
			int id = getUserId(user);
			HttpSession session = request.getSession();
			session.setAttribute("sessionId", user);
			session.setAttribute("UserId", id);
			if(isAdmin(id)) {
				session.setAttribute("admin", new Boolean(isAdmin(id)));
			}
			session.setMaxInactiveInterval(30*60);
			response.sendRedirect(response.encodeURL(request.getHeader("Referer")));
		} else {
			System.out.println("nietyay");

			RequestDispatcher rd = request.getRequestDispatcher(""); 
			PrintWriter out= response.getWriter();
			out.println("<script type=\"text/javascript\">");
			out.println("alert('Either your name or password was incorrect.');");
			out.println("window.open('login', '_parent');");
			out.println("</script>");

			rd.include(request, response);
		}
	}

	public boolean isAdmin(int id) {
		DatabaseController DB_connect = new DatabaseController();
		Connection DB_connection = DB_connect.connect();
		boolean admin = false;
		String query = "SELECT g.admin FROM gebruiker g WHERE idgebruiker = ?"
				+ ";";
		PreparedStatement DB_statement;
		try {
			DB_statement = DB_connection.prepareStatement(query);
			DB_statement.setInt(1, id);
			ResultSet DB_resultSet = DB_statement.executeQuery();
			while(DB_resultSet.next()) {
				admin = DB_resultSet.getBoolean("admin");
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}

		try {
			DB_connection.close();
			DB_connect.close();
		} catch (SQLException e1) {
			e1.printStackTrace();
		}
		System.out.println("--------admin= " + admin);
		return admin;
	}

	public int getUserId(String id) {
		DatabaseController DB_connect = new DatabaseController();
		Connection DB_connection = DB_connect.connect();
		int userid = 0;
		String query = "SELECT g.idgebruiker FROM gebruiker g WHERE gebruikersnaam = ?"
				+ ";";
		PreparedStatement DB_statement;
		try {
			DB_statement = DB_connection.prepareStatement(query);
			DB_statement.setString(1, id);
			ResultSet DB_resultSet = DB_statement.executeQuery();
			while(DB_resultSet.next()) {
				userid = DB_resultSet.getInt("idgebruiker");
			}
		} catch (SQLException e1) {
			e1.printStackTrace();
		}

		try {
			DB_connection.close();
			DB_connect.close();
		} catch (SQLException e1) {
			e1.printStackTrace();
		}		

		return userid;
	}

}
